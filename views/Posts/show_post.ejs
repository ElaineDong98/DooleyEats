<% include ../partials/header %>
<link href="//s.xiaohongshu.com/formula-static/@xhs/launcher@1.5.1/dist/Launcher.css" rel="stylesheet">
<style>
  .card-note .bottom-gap[data-v-f71fb898] {
    margin: 0 0 20px;
}
.row {
    margin-right: -15px;
    margin-left: -15px;
}
.author-item .card-info .inner span[data-v-0d757e92] {
    display: block;
    line-height: 20px;
}
.author-item .card-info .inner .collect[data-v-0d757e92], .author-item .card-info .inner .fans[data-v-0d757e92], .author-item .card-info .inner .note[data-v-0d757e92] {
    color: #4f4f4f;
    font-weight: 500;
}
.pull-right {
    margin-right: 15px;
}
.author-item .title[data-v-0d757e92] {
    font-weight: 500;
    font-size: 16px;
    padding: 10px 0 10px 20px;
    margin: 0;
    border-bottom: 1px solid #eee;
}
.author-item .card-info .inner[data-v-0d757e92] {
    float: left;
    color: #999;
    width: 86px;
    font-size: 14px;
    margin: 0 3px;
}
* {
    box-sizing: border-box;
}
.left[data-v-534aa174] {
    position: relative;
    float: left;
}
.author-item[data-v-0d757e92] {
    width: 320px;
    height: 176px;
    border: 1px solid #eee;
    border-radius: 4px;
    color: #000;
    font-size: 14px;
    background: #fff;
}
.author-info[data-v-534aa174] {
    margin: 9px 11px 0;
    padding: 0 0 10px;
    overflow: hidden;
    font-size: 12px;
    cursor: pointer;
    color: #333;
    display: block;
}
.right[data-v-534aa174] {
    float: left;
    margin: 2px 0 0 15px;
}
.name[data-v-534aa174] {
    margin: 3px 0 0;
    font-weight: 500;
    display: flex;
    flex-direction: row;
    justify-content: flex-start;
    align-items: center;
    height: 20px;
    overflow: hidden;
    white-space: nowrap;
    word-wrap: normal;
    text-overflow: ellipsis;
}
.name .name-detail[data-v-534aa174] {
    height: 16px;
    line-height: 16px;
}
* {
    box-sizing: border-box;
}
div {
    display: block;
}
body {
    font-size: 14px;
    font-family: -apple-system,SF UI Text,PingFang SC,Hiragino Sans GB,Microsoft YaHei,WenQuanYi Micro Hei,Helvetica Neue,Helvetica,Arial,sans-serif;
    color: #333;
    background-color: #fbfbfb;
}
.left-img img[data-v-534aa174] {
    border-radius: 50%;
}
.left-img .border-img[data-v-534aa174] {
    border: 1px solid rgba(0,0,0,.15);
    display: block;
    border-radius: 50%;
    position: absolute;
    top: 0;
    left: 0;
}
.author-item .card-info[data-v-0d757e92] {
    overflow: hidden;
    margin: 8px 20px;
}
.author-item .author-info[data-v-0d757e92] {
    margin: 10px 20px 0;
    padding: 0 0 10px;
    overflow: hidden;
    border-bottom: 1px solid #eee;
}
.left-card[data-v-f71fb898] {
    float: left;
    margin-top: 20px;
    width: 200px;
}
.right-card[data-v-f71fb898] {
    float: right;
    width: 1000px;
    margin-top: 20px;
}
.card-note[data-v-f71fb898] {
    width: 1350px;
    overflow: hidden;
    overflow-x: hidden;
    overflow-y: hidden;
    margin: 50px auto 50px;
    margin-top: 50px;
    margin-right: auto;
    margin-bottom: 150px;
    margin-left: auto;
    padding-bottom: 36px;
}
</style>

<html>
  <div data-v-f71fb898 data-v-70f39e76 class="card-note">
  <div data-v-f71fb898="" class = "left-card">
    <div data-v-0d757e92="" data-v-f71fb898="" class="author-item bottom-gap">
      <h3 data-v-0d757e92="" class="title">Post's Author</h3> <span data-v-534aa174="" data-v-0d757e92="" class="author-info">
        <div data-v-534aa174="" class="left">
          <div data-v-534aa174="" class="left-img"><img data-v-534aa174=""
              src= "<%= post.author.image %>"
              style="width: 50px; height: 50px;"> </div> 
        </div>
        <div data-v-534aa174="" class="right" style="width: 190px;">
          <h6 data-v-534aa174="" class="name" style="font-size: 16px;"><span data-v-534aa174=""
              class="name-detail"><a href="/users/<%= post.author.id %>"><%= post.author.username %></a></span> <i data-v-534aa174="" class="level-detail"
              style="background-image: url(&quot;https://s4.xiaohongshu.com/static/throne/property/f11_v2.png&quot;);"></i>
          </h6>
          <p data-v-534aa174="" class="brief" style="font-size: 14px;color: #999;">Member of binary 4.0</p>
        </div>
        <!---->
      </span>
      <div data-v-0d757e92="" class="card-info">
        <div data-v-0d757e92="" class="inner"><span data-v-0d757e92="">Posts</span> <span data-v-0d757e92=""
            class="note"><%= count %></span></div>
        <div data-v-0d757e92="" class="inner"><span data-v-0d757e92="">Likes</span> <span data-v-0d757e92=""
            class="fans"><%= likes %></span></div>
        <div data-v-0d757e92="" class="inner"><span data-v-0d757e92="">Contact</span> <span data-v-0d757e92=""
            class="fans">+</span></div>
      </div>
      <br>
        <div class="list-group">
          <!-- <li class="list-group-item">Would you recommend (0-10): <%= post.rating %></li> -->
          <li class="list-group-item">Post Category: <%= post.postType %></li>
          <li class="list-group-item">Tags: <%= post.tags %></li>

          <% if (post.location!=="") {%>
          <li class="list-group-item">Restaurant Location: <%= post.location %>
          <button class="btn btn-link"><a href="https://www.google.com/maps/search/<%= post.location%>">View Map</a></button></li>
          <% } %>

        </div>
        <br> <br>
        <% if (currUser && post.author.id.equals(currUser._id)) {%>
        <button class="btn profile-edit-btn btn-success"><a href="/posts/edit/<%= post.id%>">Edit Post</a></button>
        <br> <br>
        <form class="delete-form" action="/posts/<%= post.id %>?_method=DELETE" method="POST">
          <button class="btn btn-danger btn-sm">Delete</button>
        </form>
        <% } %>
        <div>
        </div>
    </div>
  </div>

<div data-v-f71fb898="" class="right-card">
  <div class="col-md-9">
    <div class="thumbnail">
      <div class="caption">
        <div class="fakeimg center">
          <img src="<%= post.image %>" class="gallery-image" alt=""
          style="margin-left: auto; display: block;
          margin-right: auto;
          width: 100%;">
          </div>
          <div><p></p></div>
        <h2><%= post.title %></h2>
        <hr>
        <div class="pull-right">
          <span>Total likes: <i class="fas fa-heart" style="color: red"></i> <%= post.likes.length %></span>
        </div>
        <hr>
        <p><b>Description:</b></p>
        <p><%= post.description %> </p>
        <hr>
        <p>
          <em>Submitted By: <a href="/users/<%= post.author.id %>"><%= post.author.username %></a></em>
        </p>
        <p>
          <em><%= post.createdAt %></em>
        </p>
      </div>
    </div>



    <div style="padding-bottom: 10px;" class="text-right">
      <form action="/posts/<%= post._id %>/like" method="POST">
        <div class="btn-group">
          <% if (post.likes.some(function (like) {
              return like.equals(currUser._id)
          })) { %>
          <button class="btn btn-sm btn-primary">
            <i class="fas fa-heart" style = "color: white"></i> Liked 
          </button>
          <% } else { %>
          <button class="btn btn-sm btn-secondary">
            <i class="fas fa-heart"></i> Like 
          </button>
          <% } %>

        </div>
      </form>
    </div>
  

    <div class="well"><!--comments section-->
      <div class="text-right">
        <a class="btn btn-success" href="/posts/<%= post._id %>/comments/new">Add New Comment</a>
      </div>
      <hr>
      <!-- Comments list -->
      
      <% for(var i = 0; i < post.comments.length; i++){ %>
          <%  var com = post.comments[i]; %>
          <div class="row">
            <div class="row">
              <div class="col-md-9">
                <h5><strong><%= com.rating_value %></strong>  <span style="color:black;">&#9733;</span>  <strong><%=com.title%></strong></h5>
              </div>
              <div class="col-md-3">
                <div class="pull-right"><strong><span class="glyphicon glyphicon-user"></span> <%=com.author.username%></strong></div>
              </div>
            </div>
          <div class="row">
            <div class="col-md-10">
                <pre><%= com.text %> </pre>
            </div>
            <div class="col-md-2">
              <span class="pull-right"><%= com.createTime.toISOString().substring(0, 10) %></span>
            </div>
          </div>

          <!-- voting info -->
          <div class="voting-buttons row" style="margin:0 auto;">
            <!--upvotes info-->
            <div class="col-md-5 col-sm-5 col-xs-5" style="padding:0; text-align:right;">
              <!--number of upvotes-->
              <span class="number-of-upvotes"></span>
              <!--list of people who upvoted(pops up on click)-->
              <span class="list-of-upvotes">
                <ul style="list-style:none; margin:5px; padding:0; ">
                  <%for(var kk=0;kk< com.upvotes.length;kk++){%>
                    <li><%=com.upvotes[kk].username%></li>
                  <% }%>
                </ul>
              </span>
            </div> -->
            <!--upvote and downvote buttons-->
            <div class="col-md-2  col-sm-2 col-xs-2 text-center" style="padding:0 10px; ">
                <form action="/posts/<%= post._id %>/comments/<%=com._id%>/upvote" method="POST">
                    <button class="fas fa-thumbs-up" style="font-size:24px"></button>
                </form> 
                <form action="/posts/<%= post._id %>/comments/<%=com._id%>/downvote" method="POST">
                    <button class="fas fa-thumbs-down" style="font-size:24px"></button>
                </form>
            </div>
            <!--downvotes info-->
            <div class="col-md-5 col-sm-5 col-xs-5" style="padding:0; text-align:left;">
              <!--number of downvotes-->
              <span class="number-of-downvotes"></span>
              <!--list of people who downvoted(pops up on click)-->
              <span class="list-of-downvotes">
                <ul style="list-style:none; margin:5px; padding:0; ">
                  <%for(var kk=0;kk< com.downvotes.length;kk++){%>
                    <li><%=com.downvotes[kk].username%></li>
                  <% }%>
                </ul>
              </span>
            </div>                           
          </div><!--end voting info-->
          <!-- edit and delete comment buttons: --> 
          <%if(currUser && (com.author.id.equals(currUser._id)|| currUser.username === "ADMIN")){%>
          <div class="row" style="margin-right:0;">
            <div class="pull-right">
                <form id="deleteform" action = "/posts/<%=post._id%>/comments/<%=com._id%>?_method=DELETE" method="POST">
                <button class = "btn btn-xs btn-danger"  >Delete</button>
                </form> 
            </div>
            <div class="pull-right">
                <a class = "btn btn-xs btn-warning" href="/posts/<%=post._id%>/comments/<%= com._id%>/edit" >Edit</a>
            </div>
          </div>
          <% } %>
        </div>
          <hr class="style10">
      <% } %><!--end of single comment-->
    </div>


  </div>
</html>


<!-- save rating values in a new array('ratings') BEFORE passing them to script tag (at bottom of document)-->
<!-- this is done because of the following error occurs otherwise :
	 Uncaught SyntaxError: Unexpected token in JSON at position 290 at JSON.parse (<anonymous>) -->
    <%var ratings = []; %>
    <%var loggedInUser = currUser ? currUser : "none";%>
    <!-- above line is because if you check if you accesss variable 'currentuser' inside script tag by using json parse,
       you will get json parsing error if no one is loggedin because if user isn't logged in, then it cannot parse null value
      the work-around is simple, just check here and use another var loggedInUser
      only if loggedInUser != "none", do required work (highlighting their upvoted and downvoted comments)
    -->
    <%for(var i=0;i< post.comments.length;i++){%>
      <% ratings.push(post.comments[i].rating_value); %>
    <% } %>
  <!-- script for filling horizontal bars and for upvote and downvote action-->
  <script type="text/javascript">
    // accessing ejs variable in javascript (camp,its comments and currentuser)
    var comms =  <%- JSON.stringify(ratings); %>;
    var comments =  <%- JSON.stringify(post.comments); %>;
    var campgroundId =  <%- JSON.stringify(post._id); %>;
    // currentuser -> the one who is logged in
    var current_user =  <%- JSON.stringify(loggedInUser); %>;
  
  
    var arr=[0,0,0,0,0,0],fr=[0,0,0,0,0,0];
    var maxVal=0,ind=0;
    for(var i=0;i<comms.length;i++)
    {
      ind=Math.round(parseFloat( comms[i] , 10 ));
      fr[ind]++;
    }
    for(var i=1;i<=5;i++)
    {
      maxVal=Math.max(fr[i],maxVal);
    }
    if(maxVal==0)
      maxVal = 1;
    for(var i=1;i<=5;i++)
    {
      arr[i] = Math.round((fr[i]*100)/maxVal);
      arr[i] = arr[i].toString() + "%";
    }
  
    // set fill % in ratings bar using jQuery
    var c=5;
    $('.horizontal .progress-fill').each(function(){
      $(this).css('width',arr[c]);
      c--;
    });
    // display frequency of ratings using jQuery
    c=5;
    $('.horizontal .ff').each(function(){
      $(this).html(fr[c].toString());
      c--;
    });	
    
    //arrays for upvotes and downvotes
    var upvotesArr=[] , downvotesArr=[];
    for(var i=0;i<comments.length;i++)
    {
      upvotesArr.push(comments[i].upvotes.length);
      downvotesArr.push(comments[i].downvotes.length);
    }
    var isUpvoted = [],isDownvoted = [];
      if(current_user!="none")
      {
        var i,j,found;
        for( i=0;i<comments.length;i++)
        {
          isUpvoted[i] = 0;
          isDownvoted[i] = 0;
          for( j=0;j<comments[i].upvotes.length;j++)
            //if user id is in the upvotes array
            if(comments[i].upvotes[j]._id == current_user._id)
            {
              isUpvoted[i] = 1;
              break;
            }
          for( j=0;j<comments[i].downvotes.length;j++)
            //if user id is in the downvotes array
            if(comments[i].downvotes[j]._id == current_user._id)
            {
              isDownvoted[i] = 1;
              break;
            }
        }
      }	
    
    // display #upvotes and #downvotes for each comment
    c=0;
    $('.number-of-upvotes').each(function(){
      $(this).html(upvotesArr[c].toString());
      c++
    });
    c=0;
    $('.number-of-downvotes').each(function(){
      $(this).html(downvotesArr[c].toString());
      c++
    });
    c=0;
      $('.voting-buttons div form .upvote').each(function(){
        //if upvote button is already clicked
        if(isUpvoted[c]==1)
        {   
          $(this).toggleClass("upvote");//remove upvote class
          $(this).toggleClass("upvoted");// add upvoted class
          // change the action of the form tag of that specific comment
          $(this).parent().attr('action','/posts/'+post._id+'/comments/'+comments[c]._id+'/undoupvote');
        }
        c++;
      });
      c=0;
      $('.voting-buttons div form .downvote').each(function(){
        //if downvote button is already clicked
        if(isDownvoted[c]==1)
        {   
          $(this).toggleClass("downvote");//remove downvote class
          $(this).toggleClass("downvoted");// add downvoted class
          // change the action of the form tag of that specific comment
          $(this).parent().attr('action','/posts/'+post._id+'/comments/'+comments[c]._id+'/undodownvote');
        }
        c++;
      });
      /*  
          display list of ppl who upvoted and downvoted on hover  
          the structure of the document is such that 
          the list to be shown(when hovered) and the element on which the hover occurs are siblings
          they are accessed using siblengs() or next( or previous() depending on the need
          Note: If only one function is specified, it will be run for both the mouseenter and mouseleave events.
      */
      $('.number-of-upvotes').hover(
          function(){   if($(this).html() != "0") $(this).next().css('visibility','visible');    },// mouseenter event
          function(){    $(this).next().css('visibility','hidden');    }                           // mouseleave event
      );
      $('.number-of-downvotes').hover(
          function(){   if($(this).html() != "0") $(this).next().css('visibility','visible');    },// mouseenter event
          function(){    $(this).next().css('visibility','hidden');    }                           // mouseleave event
      );
      
      
  </script>
  
